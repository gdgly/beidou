# Beidou-Project
项目流程

1、使用 集中器 从 DLT645-2007模拟电表软件 中采集电力数据（485串口、376.1协议）

    （1）集中器设置软件：
    初始化参数：波特率一般为（2400或9600）、通信方式485串口、规约一般为1376-2013、偶校验位
    可直接读取并修改集中器的物理地址，ip地址，主通道ip地址和端口（与集中器通过网口通信的ip，此处为单片机初始化的ip地址），子网掩码和网关（与单片机的相同），时间（修改时间便于整点上报数据）
    （2）模拟电表软件：
    初始化串口号、波特率、校验位与集中器相同（与集中器使用一个相同的电脑串口），参数设置完成直接点击右上角退出即可完成初始化
    挂表上电即可使用
    （3）智能电表测试软件
    测试模拟电表软件是否正常工作：波特率和串口号与模拟电表软件的相同，发送645协议指令即可查询
    （4）645协议和376.1协议文档
    
2、等待整点 集中器 将数据通过网口上报给 单片机，单片机使用uip协议从网口读取数据，经过数据封装，通过串口上报给北斗

    （1）MDK5软件
    用于编译基于STM32单片机的北斗终端代码，安装包、安装与破解教程、以及STM32使用教程可百度正点原子官网找到
    （2）XCOM
    （3）北斗测试软件
    （4）uip协议与uip代码移植文档
    
3、终端北斗将数据传递给服务器的北斗，再通过串口传入服务器中，服务器进行数据包解析，通过TCP协议上传给主站

    （1）linux环境搭建
    （2）config.txt文件中配置需要连接的主机ip、端口号、连接北斗的串口名称、波特率、数据位、停止位、校验位
    （3）编译前需先配置好主站
    
4、主站接收到接收到数据，打印到窗口中，并解析数据包将电力信息汇入表格

    （1）python环境搭建
    （2）主站、服务器、集中器、单片机所有的ip必须在同一个网关下（连接同一个交换机）
    （3）主站配置ip地址与端口号，连接网络开始监听端口，等待服务器连接
    

5、项目更新日志

	BD_receive.c中修改了判断报文类型的判断语句，改为判断msg.data的第5位
	BD_receive.c中把upload equiry代码注释掉，此处上传信号置1之后，会触发主函数从filename中读数据发往主站
	Socket.receive.c中增添了更新北斗时间的代码，北斗1min只能工作一次，发完数据之后需更新时间
	BD_receive.c中收到确认报文后回发给北斗的代码段进行了修改，原代码对北斗每分钟只能发送一次数据的协议处理有问题，这里对时间更新进行了修改，另外为确保数据已发送给北斗，利用北斗接受到数据之后会自动返回一组数据给连接的串口，代码中一直监听串口是否得到了返回数据，得到之后才跳出死循环，否则一直向连接北斗的串口丢数据
	Socket.receive.c中对北斗发送数据的时间更新部分的代码进行了修改
    

